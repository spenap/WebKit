<!DOCTYPE html><!-- webkit-test-runner [ WirelessPlaybackMediaPlayerEnabled=true ] -->
<html>
    <head>
        <script src='../media-file.js'></script>
        <script src='../video-test.js'></script>
        <script>
            var route;
            var video;
            var actualURL;

            async function start()
            {
                if (window.internals)
                    internals.mockMediaDeviceRouteController.enabled = true;

                video = document.createElement('video');

                const mediaType = 'video/mp4';
                const mediaURL = findMediaFile('video', '../content/test');
                const mediaURLToReject = findMediaFile('video', '../content/test_yuv420');

                const firstSource = document.createElement('source');
                firstSource.src = mediaURLToReject;
                firstSource.type = mediaType;
                video.appendChild(firstSource);

                const secondSource = document.createElement('source');
                secondSource.src = mediaURL;
                secondSource.type = mediaType;
                video.appendChild(secondSource);

                document.body.appendChild(video);

                await waitFor(video, 'canplaythrough');

                run(`video.play()`)
                await waitFor(video, 'playing');

                route = internals.mockMediaDeviceRouteController.createMockMediaDeviceRoute();

                const urlPromise = new Promise((resolve) => {
                    route.setURLCallback(async (url) => {
                        if (url === new URL(mediaURLToReject, document.baseURI).href)
                            throw new Error('URL rejected');
                        resolve(url);
                    });
                });

                run(`internals.mockMediaDeviceRouteController.activateRoute(route)`);

                const loadedURL = await urlPromise;
                const expectedURL = new URL(mediaURL, document.baseURI).href.substring(document.baseURI.indexOf('/LayoutTests/'));
                actualURL = loadedURL.substring(loadedURL.indexOf('/LayoutTests/'));

                testExpected('actualURL', expectedURL);

                endTest();
            }
        </script>
    </head>
    <body onload='start()'>
        <p>Test that a video's second &lt;source&gt; element's URL is loaded if the MediaDeviceRoute rejects the first &lt;source&gt; element's URL.</p>
    </body>
</html>
