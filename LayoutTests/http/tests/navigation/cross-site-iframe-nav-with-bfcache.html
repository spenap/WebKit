<!-- webkit-test-runner [ UsesBackForwardCache=true dumpJSConsoleLogInStdErr=true ] -->
<!DOCTYPE html>
<html>
<head>
<script src="/js-test-resources/js-test.js"></script>
<script src="resources/navigation-utils.js"></script>
<script>

description("Cross-site iframe history is preserved when the main frame navigates and pages are restored from back/forward cache.");
jsTestIsAsync = true;

const page = "opener";
var popup = null;

window.onload = function() {
    popup = window.open("resources/cross-site-iframe-nav-with-bfcache-popup.html");
}

var crossSiteShowCount = 0;

window.onmessage = (event) => dispatchMessage(event.data, {
    popup: {
        load: () => debug("Popup loaded"),
        pageshow: ({arg}) => {
            if (arg === "persisted") {
                debug("Popup pageshow: persisted (from BFCache)");
            } else {
                debug("Popup pageshow: not-persisted (initial load)");
            }
        },
    },
    samesite: {
        load: () => debug("Same-site iframe loaded"),
        pageshow: ({arg}) => {
            if (arg !== "not-persisted") {
                testFailed("Same-site iframe should not be loaded from back/forward cache on first load.");
                finishJSTest();
                return;
            }
            debug("Same-site iframe displayed (not-persisted).");
            sendMessageToPopup("navigate-to-cross-site");
        }
    },
    crosssite: {
        load: () => debug("Cross-site iframe loaded"),
        pageshow: ({arg}) => {
            crossSiteShowCount++;
            if (crossSiteShowCount == 1) {
                if (arg !== "not-persisted") {
                    testFailed("Cross-site iframe should not be loaded from back/forward cache on first load.");
                    finishJSTest();
                    return;
                }
                debug("Cross-site iframe displayed first time (not-persisted).");
                sendMessageToPopup("navigate-to-other");
            } else if (crossSiteShowCount == 2) {
                if (arg !== "persisted") {
                    testFailed("Cross-site iframe should be loaded from back/forward cache on second display.");
                    finishJSTest();
                    return;
                }
                testPassed("Cross-site iframe restored from BFCache (persisted).");
                finishJSTest();
            }
        }
    },
    other: {
        load: () => debug("Other page loaded"),
        pageshow: ({arg}) => {
            if (arg !== "not-persisted") {
                testFailed("Other page should not be loaded from back/forward cache.");
                finishJSTest();
                return;
            }
            debug("Other page displayed (not-persisted).");
            sendMessageToPopup("back1");
        }
    },
});

</script>
</head>
<body>
<ul>
    <li>Open a new window with cross-site-iframe-nav-with-bfcache-popup.html. It has a same-site iframe initially.</li>
    <li>Navigate iframe to cross-site.</li>
    <li>Navigate main frame to other.</li>
    <li>Go back. (cross-site-iframe-nav-with-bfcache-popup.html with cross-site iframe restored from BFCache)</li>
</ul>
<p>... and ensures the page with cross-site iframe is correctly restored from BFCache.</p>
</body>
</html>
