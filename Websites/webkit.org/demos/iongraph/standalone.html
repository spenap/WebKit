<!DOCTYPE html>

<head>
  <title>iongraph</title>
  <style>/* iongraph-specific styles inspired by Tachyons */

:root {
  --ig-size-1: 1rem;
  --ig-size-2: 2rem;
  --ig-size-3: 4rem;
  --ig-size-4: 8rem;
  --ig-size-5: 16rem;

  --ig-spacing-1: .25rem;
  --ig-spacing-2: .5rem;
  --ig-spacing-3: 1rem;
  --ig-spacing-4: 2rem;
  --ig-spacing-5: 4rem;
  --ig-spacing-6: 8rem;
  --ig-spacing-7: 16rem;

  --ig-text-color: black;
  --ig-text-color-dim: #777;
  --ig-background-primary: #ffb54e;
  --ig-background-light: white;
  --ig-border-color: #0c0c0d;

  --ig-block-header-color: #0c0c0d;
  --ig-loop-header-color: #1fa411;
  --ig-root-block-color: #1048af;
  --ig-movable-color: #1048af;
  --ig-rob-color: #444;
  --ig-in-worklist-color: red;

  --ig-block-selected: #ffc863;
  --ig-block-last-selected: #ffb54e;

  --ig-highlight-0: #ffb54e;
  --ig-highlight-1: #ffb5c5;
  --ig-highlight-2: #a4cbff;
  --ig-highlight-3: #8be182;
  --ig-highlight-4: #d9a4fd;

  --ig-flash-color: #ffb54e;

  /*
   * The heatmap of sample counts will effectively be sampled from a gradient:
   *
   * |----------|---------------------------------------|
   * cold     "cool"                                  hot
   *
   * The "cold" color will simply be transparent. Therefore, the "cool"
   * threshold indicates where the instruction will be fully colored and
   * noticeable to the user.
   */
  --ig-hot-color: #ff849e;
  --ig-cool-color: #ffe546;
  --ig-cool-threshold: 0.2;
}

a.ig-link-normal {
  color: inherit;
  text-decoration: inherit;
}

.ig-flex {
  display: flex;
}

.ig-flex-column {
  flex-direction: column;
}

.ig-flex-basis-0 {
  flex-basis: 0;
}

.ig-flex-grow-1 {
  flex-grow: 1;
}

.ig-flex-shrink-0 {
  flex-shrink: 0;
}

.ig-flex-shrink-1 {
  flex-shrink: 1;
}

.ig-items-center {
  align-items: center;
}

.ig-relative {
  position: relative;
}

.ig-absolute {
  position: absolute;
}

.ig-absolute-fill {
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
}

.ig-g1 {
  gap: var(--ig-spacing-1);
}

.ig-g2 {
  gap: var(--ig-spacing-2);
}

.ig-g3 {
  gap: var(--ig-spacing-3);
}

.ig-w1 {
  width: var(--ig-size-1);
}

.ig-w2 {
  width: var(--ig-size-2);
}

.ig-w3 {
  width: var(--ig-size-3);
}

.ig-w4 {
  width: var(--ig-size-4);
}

.ig-w5 {
  width: var(--ig-size-5);
}

.ig-w-100 {
  width: 100%;
}

.ig-ba {
  border-style: solid;
  border-width: 1px;
  border-color: var(--ig-border-color);
}

.ig-bt {
  border-top-style: solid;
  border-top-width: 1px;
  border-color: var(--ig-border-color);
}

.ig-br {
  border-right-style: solid;
  border-right-width: 1px;
  border-color: var(--ig-border-color);
}

.ig-bb {
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-color: var(--ig-border-color);
}

.ig-bl {
  border-left-style: solid;
  border-left-width: 1px;
  border-color: var(--ig-border-color);
}

.ig-pa1 {
  padding: var(--ig-spacing-1);
}

.ig-pa2 {
  padding: var(--ig-spacing-2);
}

.ig-pa3 {
  padding: var(--ig-spacing-3);
}

.ig-ph1 {
  padding-left: var(--ig-spacing-1);
  padding-right: var(--ig-spacing-1);
}

.ig-ph2 {
  padding-left: var(--ig-spacing-2);
  padding-right: var(--ig-spacing-2);
}

.ig-ph3 {
  padding-left: var(--ig-spacing-3);
  padding-right: var(--ig-spacing-3);
}

.ig-pv1 {
  padding-top: var(--ig-spacing-1);
  padding-bottom: var(--ig-spacing-1);
}

.ig-pv2 {
  padding-top: var(--ig-spacing-2);
  padding-bottom: var(--ig-spacing-2);
}

.ig-pv3 {
  padding-top: var(--ig-spacing-3);
  padding-bottom: var(--ig-spacing-3);
}

.ig-pt1 {
  padding-top: var(--ig-spacing-1);
}

.ig-pt2 {
  padding-top: var(--ig-spacing-2);
}

.ig-pt3 {
  padding-top: var(--ig-spacing-3);
}

.ig-pr1 {
  padding-right: var(--ig-spacing-1);
}

.ig-pr2 {
  padding-right: var(--ig-spacing-2);
}

.ig-pr3 {
  padding-right: var(--ig-spacing-3);
}

.ig-pb1 {
  padding-bottom: var(--ig-spacing-1);
}

.ig-pb2 {
  padding-bottom: var(--ig-spacing-2);
}

.ig-pb3 {
  padding-bottom: var(--ig-spacing-3);
}

.ig-pl1 {
  padding-left: var(--ig-spacing-1);
}

.ig-pl2 {
  padding-left: var(--ig-spacing-2);
}

.ig-pl3 {
  padding-left: var(--ig-spacing-3);
}

.ig-f1 {
  font-size: 3rem;
}

.ig-f2 {
  font-size: 2.25rem;
}

.ig-f3 {
  font-size: 1.5rem;
}

.ig-f4 {
  font-size: 1.25rem;
}

.ig-f5 {
  font-size: 1rem;
}

.ig-f6 {
  font-size: .875rem;
}

.ig-f7 {
  font-size: .75rem;
}

.ig-text-normal {
  color: var(--ig-text-color);
}

.ig-text-dim {
  color: var(--ig-text-color-dim);
}

.ig-tl {
  text-align: left;
}

.ig-tr {
  text-align: right;
}

.ig-tc {
  text-align: center;
}

.ig-bg-white {
  background-color: var(--ig-background-light);
}

.ig-bg-primary {
  background-color: var(--ig-background-primary);
}

.ig-overflow-hidden {
  overflow: hidden;
}

.ig-overflow-auto {
  overflow: auto;
}

.ig-overflow-x-auto {
  overflow-x: auto;
}

.ig-overflow-y-auto {
  overflow-y: auto;
}

.ig-hide-if-empty:empty {
  display: none;
}

/* Non-utility styles */

.ig-graph {
  color: var(--ig-text-color);
  position: absolute;
  left: 0;
  top: 0;
  isolation: isolate;
}

.ig-block {
  position: absolute;

  .ig-block-header {
    font-weight: bold;
    text-align: center;
    background-color: var(--ig-block-header-color);
    color: white;
    padding: 0 1em;
    border: 1px solid var(--ig-border-color);
    border-width: 1px 1px 0;
  }

  .ig-instructions {
    padding: 0.5em;
    border: 1px solid var(--ig-border-color);
    border-width: 0 1px 1px;

    table {
      border-collapse: collapse;
    }

    td,
    th {
      white-space: nowrap;
      padding: 0.1em 0.5em;
    }

    th {
      font-weight: normal;
    }
  }

  &.ig-selected {
    outline: 4px solid var(--ig-block-selected);
  }

  &.ig-last-selected {
    outline-color: var(--ig-block-last-selected);
  }
}

.ig-block-att-loopheader {
  .ig-block-header {
    background-color: var(--ig-loop-header-color);
  }
}

.ig-block-att-root {
  .ig-block-header {
    background-color: var(--ig-root-block-color);
  }
}

.ig-block-att-splitedge {
  .ig-instructions {
    border-style: dotted;
    border-width: 0 2px 2px;
  }
}

.ig-ins-num {
  text-align: right;
  cursor: pointer;
}

.ig-ins-type {
  text-align: right;
}

.ig-ins-samples {
  font-size: 0.875em;
  text-align: right;
  cursor: pointer;
}

.ig-use {
  padding: 0 0.25em;
  border-radius: 2px;
  cursor: pointer;
}

.ig-edge-label {
  position: absolute;
  font-size: 0.8em;
  line-height: 1;
  bottom: -1em;
  padding-left: 4px;
}

.ig-ins-att-RecoveredOnBailout {
  color: var(--ig-rob-color);
}

.ig-ins-att-Movable {
  color: var(--ig-movable-color);
}

.ig-ins-att-Guard {
  text-decoration: underline;
}

.ig-ins-att-InWorklist {
  color: var(--ig-in-worklist-color);
}

.ig-can-flash {
  transition: outline-color 1s ease-out;
  outline: 3px solid color-mix(in srgb, var(--ig-flash-color) 0%, transparent);
}

.ig-flash {
  transition: outline-color 0s;
  outline-color: var(--ig-flash-color);
}

.ig-hotness {
  --ig-hotness: 0;

  --ig-cold-color: color-mix(in srgb, var(--ig-cool-color) 20%, transparent);
  background-color:
    /* cool <-> hot */
    color-mix(in oklab,
      /* cold <-> cool */
      color-mix(in oklab,
        /* dead or cold */
        color-mix(in srgb, transparent, var(--ig-cold-color) clamp(0%, calc(var(--ig-hotness) * 100000000%), 100%)),
        var(--ig-cool-color) clamp(0%, calc((var(--ig-hotness) / var(--ig-cool-threshold)) * 100%), 100%)),
      var(--ig-hot-color) clamp(0%, calc(((var(--ig-hotness) - var(--ig-cool-threshold)) / (1 - var(--ig-cool-threshold))) * 100%), 100%));
}

.ig-highlight {
  --ig-highlight-color: transparent;
  background-color: var(--ig-highlight-color);
}</style>
  <style>* {
  box-sizing: border-box;
}

:root {
  font-size: 0.875rem;
}

body {
  margin: 0;
  background-color: #e5e8ea;
  /* Font, and many other styles, taken from the Firefox Profiler/ */
  font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen-Sans, Ubuntu, Noto Sans, Liberation Sans, Cantarell, Helvetica Neue, sans-serif;
}

#container {
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
}

.tweaks-panel {
  position: absolute;
  bottom: 0;
  right: 0;
  padding: 1rem;
  border: 1px solid black;
  border-width: 1px 0 0 1px;
  background-color: white;
}</style>
</head>

<body>
  <script>"use strict";var iongraph=(()=>{var _=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var dt=Object.getOwnPropertyNames;var ht=Object.prototype.hasOwnProperty;var ut=(a,t)=>{for(var e in t)_(a,e,{get:t[e],enumerable:!0})},pt=(a,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of dt(t))!ht.call(a,o)&&o!==e&&_(a,o,{get:()=>t[o],enumerable:!(s=ct(t,o))||s.enumerable});return a};var mt=a=>pt(_({},"__esModule",{value:!0}),a);var Dt={};ut(Dt,{StandaloneUI:()=>q,WebUI:()=>U});function j(a){a.version===void 0&&(a.version=0);for(let t of a.functions)ft(t,a.version);return a.version=1,a}function ft(a,t){for(let e of a.passes){for(let s of e.mir.blocks)gt(s,t);for(let s of e.lir.blocks)kt(s,t)}return a}function gt(a,t){t===0&&(a.ptr=(a.id??a.number)+1,a.id=a.number);for(let e of a.instructions)bt(e,t);return a}function bt(a,t){return t===0&&(a.ptr=a.id),a}function kt(a,t){t===0&&(a.ptr=a.id??a.number,a.id=a.number);for(let e of a.instructions)yt(e,t);return a}function yt(a,t){return t===0&&(a.ptr=a.id,a.mirPtr=null),a}function V(a,t,e){return Math.max(t,Math.min(e,a))}function A(a,t,e,s){return(a-t)*Math.pow(e,s)+t}function w(a,t,e=!1){if(!a)if(e)console.error(t??"Assertion failed");else throw new Error(t??"Assertion failed")}function I(a,t){return w(a,t),a}function xt(a){return typeof a=="string"?document.createTextNode(a):a}function wt(a,t){for(let e of t)e&&a.appendChild(xt(e))}function b(a,t,e,s){let o=document.createElement(a);if(t&&t.length>0){let n=t.filter(r=>!!r);o.classList.add(...n)}return e?.(o),s&&wt(o,s),o}var K=Object.prototype.hasOwnProperty;function C(a,t){var e,s;if(a===t)return!0;if(a&&t&&(e=a.constructor)===t.constructor){if(e===Date)return a.getTime()===t.getTime();if(e===RegExp)return a.toString()===t.toString();if(e===Array){if((s=a.length)===t.length)for(;s--&&C(a[s],t[s]););return s===-1}if(!e||typeof a=="object"){s=0;for(e in a)if(K.call(a,e)&&++s&&!K.call(t,e)||!(e in t)||!C(a[e],t[e]))return!1;return Object.keys(t).length===s}}return a!==a&&t!==t}function B(a,t,e={}){let s=t,o=[],n={get(){return s},set(r){s=r;for(let i of o)i(s)},valueOf(){return s},toString(){return String(s)},[Symbol.toPrimitive](r){return r==="string"?String(s):s},onChange(r){o.push(r)},initial:t,name:a,min:e.min??0,max:e.max??100,step:e.step??1};return(e.tweaksObject??G).add(n)}var O=class{constructor(t){this.container=t.container,this.tweaks=[],this.callbacks=[]}add(t){let e=this.tweaks.find(c=>c.name===t.name);if(e)return e;this.tweaks.push(t);let s=document.createElement("div");this.container.appendChild(s),s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="end",s.style.gap="0.5rem";let o=t.name.replace(/[a-zA-Z0-9]/g,"_"),n=document.createElement("label");s.appendChild(n),n.innerText=t.name,n.htmlFor=`tweak-${o}-input`;let r=document.createElement("input");s.appendChild(r),r.type="number",r.value=String(t),r.id=`tweak-${o}-input`,r.style.width="4rem",r.addEventListener("input",()=>{t.set(r.valueAsNumber)});let i=document.createElement("input");s.appendChild(i),i.type="range",i.value=String(t),i.min=String(t.min),i.max=String(t.max),i.step=t.step===0?"any":String(t.step),i.addEventListener("input",()=>{t.set(i.valueAsNumber)});let l=document.createElement("button");return s.appendChild(l),l.innerText="Reset",l.disabled=t.get()===t.initial,l.addEventListener("click",()=>{t.set(t.initial)}),t.onChange(c=>{r.value=String(c),i.value=String(c),l.disabled=t.get()===t.initial;for(let h of this.callbacks)h(t)}),t}onTweak(t){this.callbacks.push(t)}},W=document.createElement("div");W.classList.add("tweaks-panel");var G=new O({container:W});G.onTweak(a=>{window.dispatchEvent(new CustomEvent("tweak",{detail:a}))});window.tweaks=G;var vt=document.createElement("div"),Pt=new O({container:vt}),Q=B("Test Value",3,{tweaksObject:Pt});Q.set(4);Q=4;var it=B("Debug?",0,{min:0,max:1}),L=20,N=44,v=16,T=60,$=12,M=36,tt=16;var Lt=40,It=B("Layout Iterations",2,{min:0,max:6}),et=B("Nearly Straight Threshold",30,{min:0,max:200}),Bt=B("Nearly Straight Iterations",8,{min:0,max:10}),Tt=B("Stop At Pass",30,{min:0,max:30}),St=1.5,Ct=.01,Nt=1,Mt=.1,R=40,J=1,st=2,nt=4,E=0,Y=1,D=new Proxy(console,{get(a,t){let e=a[t];return typeof e!="function"?e:+it?e.bind(a):()=>{}}}),F=class{constructor(t,e,s={}){this.stabilizationTimeout=null;this.layoutFinalized=!1;this.deferredJumpToBlock=null;this.viewport=t;let o=t.getBoundingClientRect();this.viewportSize={x:o.width,y:o.height},this.graphContainer=document.createElement("div"),this.graphContainer.classList.add("ig-graph"),this.graphContainer.style.transformOrigin="top left",this.viewport.appendChild(this.graphContainer),this.sampleCounts=s.sampleCounts,this.maxSampleCounts=[0,0],this.heatmapMode=E;for(let[n,r]of this.sampleCounts?.totalLineHits??[])this.maxSampleCounts[E]=Math.max(this.maxSampleCounts[E],r);for(let[n,r]of this.sampleCounts?.selfLineHits??[])this.maxSampleCounts[Y]=Math.max(this.maxSampleCounts[Y],r);this.size={x:0,y:0},this.numLayers=0,this.zoom=1,this.translation={x:0,y:0},this.animating=!1,this.targetZoom=1,this.targetTranslation={x:0,y:0},this.startMousePos={x:0,y:0},this.lastMousePos={x:0,y:0},this.selectedBlockPtrs=new Set,this.lastSelectedBlockPtr=0,this.nav={visited:[],currentIndex:-1,siblings:[]},this.highlightedInstructions=[],this.instructionPalette=s.instructionPalette??[0,1,2,3,4].map(n=>`var(--ig-highlight-${n})`),this.blocks=e.mir.blocks.map(n=>{let r={ptr:n.ptr,id:n.id,mir:n,lir:e.lir.blocks.find(i=>i.id===n.id)??null,preds:[],succs:[],el:void 0,size:{x:0,y:0},layer:-1,layoutNode:void 0,isLoopHeader:!1,isBackedge:!1,isRoot:!1,isOSRTarget:!1,isCatchEntrypoint:!1};return w(r.ptr,"blocks must always have non-null ptrs"),r}),this.blocksByID=new Map,this.blocksByPtr=new Map,this.insPtrsByID=new Map,this.insIDsByPtr=new Map;for(let n of this.blocks){this.blocksByID.set(n.id,n),this.blocksByPtr.set(n.ptr,n);for(let r of n.mir.instructions)this.insPtrsByID.set(r.id,r.ptr),this.insIDsByPtr.set(r.ptr,r.id);if(n.lir)for(let r of n.lir.instructions)this.insPtrsByID.set(r.id,r.ptr),this.insIDsByPtr.set(r.ptr,r.id)}for(let n of this.blocks)n.preds=n.mir.predecessors.map(r=>I(this.blocksByID.get(r))),n.succs=n.mir.successors.map(r=>I(this.blocksByID.get(r))),n.isRoot=n.preds.length===0,n.isOSRTarget=n.mir.attributes.includes("osr"),n.isCatchEntrypoint=n.mir.attributes.includes("catch");this.assignLayers();for(let n of this.blocks)n.el=this.renderBlock(n);for(let n of this.blocks)n.size={x:n.el.offsetWidth,y:n.el.offsetHeight};this.runLayout(),this.stabilizationTimeout=window.setTimeout(()=>{this.stabilizationTimeout=null;let n=!1;for(let r of this.blocks){let i=r.el.offsetWidth,l=r.el.offsetHeight;(Math.abs(r.size.x-i)>1||Math.abs(r.size.y-l)>1)&&(r.size={x:i,y:l},n=!0)}n&&this.runLayout(),this.layoutFinalized=!0,D.log("Graph layout finalized.")},100),this.addEventListeners()}runLayout(){let[t,e,s]=this.layout(),o=Array.from(this.graphContainer.children);for(let n of o)n.classList.contains("ig-block")||n.remove();if(this.render(t,e,s),this.deferredJumpToBlock){let{blockPtr:n,opts:r}=this.deferredJumpToBlock;this.deferredJumpToBlock=null,this.jumpToBlock(n,r)}}layout(){let t=this.makeLayoutNodes();this.straightenEdges(t);let e=this.finagleJoints(t),s=this.verticalize(t,e);return[t,s,e]}findLayoutRoots(){let t=[],e=[],s=this.blocks.filter(o=>o.preds.length===0);for(let o of s)t.push(o),o.mir.attributes.includes("osr")&&e.push(o);if(t.length===0&&this.blocks.length>0){let o=[...this.blocks].sort((n,r)=>n.id-r.id);t.push(o[0])}return[t,e]}detectCycles(){let t=new Map,e=new Map,s=o=>{t.set(o,1);for(let n of o.succs){let r=t.get(n)??0;if(r===1){let i=e.get(o);i||(i=new Set,e.set(o,i)),i.add(n),o.isBackedge=!0,n.isLoopHeader=!0}else r===0&&s(n)}t.set(o,2)};for(let o of this.blocks)t.has(o)||s(o);return e}assignLayers(){let t=this.detectCycles();for(let o of this.blocks)o.layer=-1;let e=o=>{if(o.layer!==-1)return o.layer;let n=-1;for(let r of o.preds){let i=t.get(r);if(i&&i.has(o))continue;let l=e(r);l>n&&(n=l)}return o.layer=n+1,o.layer},s=0;for(let o of this.blocks){let n=e(o);n>s&&(s=n)}this.numLayers=s+1,D.log(`Assigned generic layers. Max layer: ${s}`)}makeLayoutNodes(){D.group("makeLayoutNodes");function t(i,l,c){i.dstNodes[l]=c,c.srcNodes.includes(i)||c.srcNodes.push(i)}let e;{let i={};for(let l of this.blocks){let c=l.layer<0?0:l.layer;i[c]||(i[c]=[]),i[c].push(l)}e=Object.entries(i).map(([l,c])=>[Number(l),c]).sort((l,c)=>l[0]-c[0]).map(([l,c])=>c)}let s=[];for(let i=0;i<this.numLayers;i++)s[i]=e.find(l=>l[0]?.layer===i)||[];let o=0,n=s.map(()=>[]),r=[];for(let[i,l]of s.entries()){let c=[];for(let d of l)for(let u=r.length-1;u>=0;u--){let p=r[u];p.dstBlock===d&&(c.unshift(p),r.splice(u,1))}let h=new Map;for(let d of r){let u=h.get(d.dstBlock.id);u?t(d.src,d.srcPort,u):(u={id:o++,pos:{x:L,y:L},size:{x:0,y:0},block:null,srcNodes:[],dstNodes:[],dstBlock:d.dstBlock,jointOffsets:[],flags:0},t(d.src,d.srcPort,u),n[i].push(u),h.set(d.dstBlock.id,u)),d.src=u,d.srcPort=0}for(let d of l){let u={id:o++,pos:{x:L,y:L},size:d.size,block:d,srcNodes:[],dstNodes:[],jointOffsets:[],flags:0};d.layoutNode=u,n[i].push(u);for(let p of c)p.dstBlock===d&&t(p.src,p.srcPort,u)}for(let d of l)d.succs.forEach((u,p)=>{if(u.layer>i)u.layer===i+1?r.push({src:d.layoutNode,srcPort:p,dstBlock:u}):r.push({src:d.layoutNode,srcPort:p,dstBlock:u});else{let m=i,f=u.layer,g=d.layoutNode,y=p;for(let x=m;x>=f;x--){let k={id:o++,pos:{x:L,y:L},size:{x:0,y:0},block:null,srcNodes:[],dstNodes:[],dstBlock:u,jointOffsets:[],flags:nt};n[x].push(k),t(g,y,k),g=k,y=0}u.layoutNode&&t(g,y,u.layoutNode)}})}for(let i of n){for(let l=0;l<i.length&&i[l].block===null;l++)i[l].flags|=J;for(let l=i.length-1;l>=0&&i[l].block===null;l--)i[l].flags|=st}return D.groupEnd(),n}straightenEdges(t){let e=d=>{for(let u=0;u<d.length-1;u++){let p=d[u],m=d[u+1],f=p.block===null&&m.block!==null,g=p.pos.x+p.size.x+(f?v:0)+N;m.pos.x=Math.max(m.pos.x,g)}},s=()=>{let d=new Map;for(let u of Z(t)){let p=u.dstBlock,m=u.pos.x;d.set(p,Math.max(d.get(p)??0,m))}for(let u of Z(t)){let p=u.dstBlock,m=d.get(p);m&&(u.pos.x=m)}for(let u of t)e(u)},o=()=>{let d=new Map;for(let u of t){let p=0,m=0;for(;p<u.length;p++)if(!(u[p].flags&J)){m=u[p].pos.x;break}for(p-=1,m-=N+v;p>=0;p--){let f=u[p],g=m;for(let y of f.srcNodes){let x=y.pos.x+y.dstNodes.indexOf(f)*T;x<g&&(g=x)}f.pos.x=g,m=f.pos.x-N,d.set(f.dstBlock,Math.min(d.get(f.dstBlock)??1/0,g))}}for(let u of Z(t)){if(!(u.flags&J))continue;let p=d.get(u.dstBlock);p&&(u.pos.x=p)}},n=()=>{for(let d=0;d<t.length-1;d++){let u=t[d];e(u);let p=-1;for(let m of u)for(let[f,g]of m.dstNodes.entries()){if(!t[d+1].includes(g))continue;let y=t[d+1].indexOf(g);if(y>p&&g.srcNodes[0]===m){let x=v+T*f,k=v,P=g.pos.x;g.pos.x=Math.max(g.pos.x,m.pos.x+x-k),g.pos.x!==P&&(p=y)}}}},r=()=>{for(let d of t){for(let u=d.length-1;u>=0;u--){let p=d[u];if(!p.block||p.block.isLoopHeader)continue;let m=[];for(let f of p.srcNodes){let g=v+f.dstNodes.indexOf(p)*T,y=v;m.push(f.pos.x+g-(p.pos.x+y))}for(let[f,g]of p.dstNodes.entries()){if(g.block===null&&g.dstBlock.isLoopHeader)continue;let y=v+f*T,x=v;m.push(g.pos.x+x-(p.pos.x+y))}if(!m.includes(0)){m=m.filter(f=>f>0).sort((f,g)=>f-g);for(let f of m){let g=!1;for(let y=u+1;y<d.length;y++){let x=d[y];if(x.flags&st)continue;let k=p.pos.x+f,P=p.pos.x+f+p.size.x,at=x.pos.x-N,lt=x.pos.x+x.size.x+N;P>=at&&k<=lt&&(g=!0)}if(!g){p.pos.x+=f;break}}}}e(d)}},i=()=>{for(let d=t.length-1;d>=0;d--){let u=t[d];e(u);for(let p of u)for(let m of p.srcNodes){if(m.block!==null)continue;Math.abs(m.pos.x-p.pos.x)<=et&&(m.pos.x=Math.max(m.pos.x,p.pos.x),p.pos.x=Math.max(m.pos.x,p.pos.x))}}},l=()=>{for(let d=0;d<t.length;d++){let u=t[d];e(u);for(let p of u){if(p.dstNodes.length===0)continue;let m=p.dstNodes[0];if(m.block!==null)continue;Math.abs(m.pos.x-p.pos.x)<=et&&(m.pos.x=Math.max(m.pos.x,p.pos.x),p.pos.x=Math.max(m.pos.x,p.pos.x))}}};function c(d,u){let p=[];for(let m=0;m<u;m++)for(let f of d)p.push(f);return p}let h=[...c([n,s],It),s,...c([i,l],Bt),r,s,o];for(let[d,u]of h.entries())d<Tt&&u()}finagleJoints(t){let e=[];for(let s of t){let o=[];for(let c of s){c.jointOffsets=new Array(c.dstNodes.length).fill(0);for(let[h,d]of c.dstNodes.entries()){if(d.pos.y<c.pos.y)continue;let u=c.pos.x+v+T*h,p=d.pos.x+v;Math.abs(p-u)<2*$||o.push({x1:u,x2:p,src:c,srcPort:h,dst:d})}}o.sort((c,h)=>c.x1-h.x1);let n=[],r=[];t:for(let c of o){let h=c.x2-c.x1>=0?n:r,d=null;for(let u=h.length-1;u>=0;u--){let p=h[u],m=!1;for(let f of p){if(c.dst===f.dst){p.push(c);continue t}let g=Math.min(c.x1,c.x2),y=Math.max(c.x1,c.x2),x=Math.min(f.x1,f.x2),k=Math.max(f.x1,f.x2);if(y>=x&&g<=k){m=!0;break}}if(m)break;d=p}d?d.push(c):h.push([c])}let i=Math.max(0,n.length+r.length-1)*tt,l=-i/2;for(let c of[...n.reverse(),...r]){for(let h of c)h.src.jointOffsets[h.srcPort]=l;l+=tt}e.push(i)}return e}verticalize(t,e){let s=new Array(t.length),o=L;for(let n=0;n<t.length;n++){let r=t[n],i=0;for(let l of r)l.pos.y=o,i=Math.max(i,l.size.y);s[n]=i,o+=i+M+e[n]+M}return s}renderBlock(t){let e=document.createElement("div");this.graphContainer.appendChild(e),e.classList.add("ig-block","ig-bg-white");for(let i of t.mir.attributes)e.classList.add(`ig-block-att-${i}`);e.setAttribute("data-ig-block-ptr",`${t.ptr}`),e.setAttribute("data-ig-block-id",`${t.id}`);let s=[];t.isRoot&&(s.push("(root)"),e.classList.add("ig-block-att-root")),t.isCatchEntrypoint&&s.push("(catch)"),t.isOSRTarget&&s.push("(osr)"),t.isLoopHeader&&(s.push("(loop header)"),e.classList.add("ig-block-att-loopheader")),t.isBackedge&&(s.push("(backedge)"),e.classList.add("ig-block-att-backedge"));let o=document.createElement("div");o.classList.add("ig-block-header"),o.innerText=`Block ${t.id}${s.length===0?"":" "+s.join(" ")}`,e.appendChild(o);let n=document.createElement("div");n.classList.add("ig-instructions"),e.appendChild(n);let r=document.createElement("table");if(t.lir){r.innerHTML=`
        <colgroup>
          <col style="width: 1px">
          <col style="width: auto">
          ${this.sampleCounts?`
            <col style="width: 1px">
            <col style="width: 1px">
          `:""}
        </colgroup>
        ${this.sampleCounts?`
          <thead>
            <tr>
              <th></th>
              <th></th>
              <th class="ig-f6">Total</th>
              <th class="ig-f6">Self</th>
            </tr>
          </thead>
        `:""}
      `;for(let i of t.lir.instructions)r.appendChild(this.renderLIRInstruction(i))}else{r.innerHTML=`
        <colgroup>
          <col style="width: 1px">
          <col style="width: auto">
          <col style="width: 1px">
        </colgroup>
      `;for(let i of t.mir.instructions)r.appendChild(this.renderMIRInstruction(i))}n.appendChild(r);for(let[i,l]of t.succs.entries()){let c=document.createElement("div");c.innerText=`#${l.id}`,c.classList.add("ig-edge-label"),c.style.left=`${v+T*i}px`,e.appendChild(c)}return o.addEventListener("pointerdown",i=>{i.preventDefault(),i.stopPropagation()}),o.addEventListener("click",i=>{i.stopPropagation(),i.shiftKey||this.selectedBlockPtrs.clear(),this.setSelection([],t.ptr)}),e}render(t,e,s){for(let l of t)for(let c of l)if(c.block!==null){let h=c.block;h.el.style.left=`${c.pos.x}px`,h.el.style.top=`${c.pos.y}px`}let o=0,n=0;for(let l of t)for(let c of l)o=Math.max(o,c.pos.x+c.size.x+L),n=Math.max(n,c.pos.y+c.size.y+L);let r=document.createElementNS("http://www.w3.org/2000/svg","svg");this.graphContainer.appendChild(r);let i=(l,c)=>{for(let h of l)o=Math.max(o,h+L);for(let h of c)n=Math.max(n,h+L)};for(let l=0;l<t.length;l++){let c=t[l];for(let h of c){w(h.dstNodes.length===h.jointOffsets.length,"must have a joint offset for each destination");for(let[d,u]of h.dstNodes.entries()){let p=h.pos.x+v+T*d,m=h.pos.y+h.size.y,f=u.pos.x+v,g=u.pos.y,y=g<m,x=k=>(k.flags&nt)!==0;if(h.block&&u.block===null&&y){let k=m+M,P=Ht(p,m,f,g,k);r.appendChild(P),i([p,f],[m,g,k])}else if(h.block===null&&u.block!==null&&Math.abs(m-g)<1){let k=g-Lt,P=At(p,m,f,g,k);r.appendChild(P),i([p,f],[m,g,k])}else if(y){let k=m-M,P=$t(p,m,f,g,k,u.block!==null);r.appendChild(P),i([p,f],[m,g,k])}else{let k=m-h.size.y+e[l]+M+s[l]/2+h.jointOffsets[d],P=Et(p,m,f,g,k,u.block!==null);r.appendChild(P),i([p,f],[m,g,k])}}}}if(r.setAttribute("width",`${o}`),r.setAttribute("height",`${n}`),this.size={x:o,y:n},+it)for(let l of t)for(let c of l){let h=document.createElement("div");h.appendChild(document.createTextNode(String(c.id))),h.appendChild(document.createElement("br")),h.appendChild(document.createTextNode(`L:${c.block?.layer}`)),h.appendChild(document.createElement("br")),h.appendChild(document.createTextNode(`<- ${c.srcNodes.map(d=>d.id)}`)),h.appendChild(document.createElement("br")),h.appendChild(document.createTextNode(`-> ${c.dstNodes.map(d=>d.id)}`)),h.style.position="absolute",h.style.border="1px solid black",h.style.backgroundColor="white",h.style.left=`${c.pos.x}px`,h.style.top=`${c.pos.y}px`,h.style.whiteSpace="nowrap",this.graphContainer.appendChild(h)}this.updateHighlightedInstructions(),this.updateHotness()}renderMIRInstruction(t){let e=t.opcode.replace("->","\u2192").replace("<-","\u2190"),s=document.createElement("tr");s.classList.add("ig-ins","ig-ins-mir","ig-can-flash",...t.attributes.map(h=>`ig-ins-att-${h}`)),s.setAttribute("data-ig-ins-ptr",`${t.ptr}`),s.setAttribute("data-ig-ins-id",`${t.id}`);let o=document.createElement("td");o.classList.add("ig-ins-num"),o.innerText=String(t.id),s.appendChild(o);let n=document.createElement("td"),r=/([A-Za-z0-9_<>]+)#(\d+)/g,i=0,l;for(;(l=r.exec(e))!==null;){if(l.index>i){let d=e.substring(i,l.index);n.appendChild(document.createTextNode(d))}let h=document.createElement("span");h.className="ig-use ig-highlightable",h.setAttribute("data-ig-use",encodeURIComponent(l[2])),h.textContent=`${l[1]}#${l[2]}`,n.appendChild(h),i=r.lastIndex}if(i<e.length){let h=e.substring(i);n.appendChild(document.createTextNode(h))}s.appendChild(n);let c=document.createElement("td");return c.classList.add("ig-ins-type"),c.innerText=t.type==="None"?"":t.type,s.appendChild(c),o.addEventListener("pointerdown",h=>{h.preventDefault(),h.stopPropagation()}),o.addEventListener("click",()=>{this.toggleInstructionHighlight(t.ptr)}),n.querySelectorAll(".ig-use").forEach(h=>{h.addEventListener("pointerdown",d=>{d.preventDefault(),d.stopPropagation()}),h.addEventListener("click",d=>{let u=parseInt(I(h.getAttribute("data-ig-use")),10);this.jumpToInstruction(u,{zoom:1})})}),s}renderLIRInstruction(t){let e=t.opcode.replace("->","\u2192").replace("<-","\u2190"),s=document.createElement("tr");s.classList.add("ig-ins","ig-ins-lir","ig-hotness"),s.setAttribute("data-ig-ins-ptr",`${t.ptr}`),s.setAttribute("data-ig-ins-id",`${t.id}`);let o=document.createElement("td");o.classList.add("ig-ins-num"),o.innerText=String(t.id),s.appendChild(o);let n=document.createElement("td");if(n.innerText=e,s.appendChild(n),this.sampleCounts){let r=this.sampleCounts?.totalLineHits.get(t.id)??0,i=this.sampleCounts?.selfLineHits.get(t.id)??0,l=document.createElement("td");l.classList.add("ig-ins-samples"),l.classList.toggle("ig-text-dim",r===0),l.innerText=`${r}`,l.title="Color by total count",s.appendChild(l);let c=document.createElement("td");c.classList.add("ig-ins-samples"),c.classList.toggle("ig-text-dim",i===0),c.innerText=`${i}`,c.title="Color by self count",s.appendChild(c);for(let[h,d]of[l,c].entries())d.addEventListener("pointerdown",u=>{u.preventDefault(),u.stopPropagation()}),d.addEventListener("click",()=>{w(h===E||h===Y),this.heatmapMode=h,this.updateHotness()})}return o.addEventListener("pointerdown",r=>{r.preventDefault(),r.stopPropagation()}),o.addEventListener("click",()=>{this.toggleInstructionHighlight(t.ptr)}),s}renderSelection(){this.graphContainer.querySelectorAll(".ig-block").forEach(t=>{let e=parseInt(I(t.getAttribute("data-ig-block-ptr")),10);t.classList.toggle("ig-selected",this.selectedBlockPtrs.has(e)),t.classList.toggle("ig-last-selected",this.lastSelectedBlockPtr===e)})}removeNonexistentHighlights(){this.highlightedInstructions=this.highlightedInstructions.filter(t=>this.graphContainer.querySelector(`.ig-ins[data-ig-ins-ptr="${t.ptr}"]`))}updateHighlightedInstructions(){for(let t of this.highlightedInstructions)w(this.highlightedInstructions.filter(e=>e.ptr===t.ptr).length===1,`instruction ${t.ptr} was highlighted more than once`);this.graphContainer.querySelectorAll(".ig-ins, .ig-use").forEach(t=>{Ot(t)});for(let t of this.highlightedInstructions){let e=this.instructionPalette[t.paletteColor%this.instructionPalette.length],s=this.graphContainer.querySelector(`.ig-ins[data-ig-ins-ptr="${t.ptr}"]`);if(s){ot(s,e);let o=this.insIDsByPtr.get(t.ptr);this.graphContainer.querySelectorAll(`.ig-use[data-ig-use="${o}"]`).forEach(n=>{ot(n,e)})}}}updateHotness(){this.graphContainer.querySelectorAll(".ig-ins-lir").forEach(t=>{w(t.classList.contains("ig-hotness"));let e=parseInt(I(t.getAttribute("data-ig-ins-id")),10),s=0;this.sampleCounts&&(s=((this.heatmapMode===E?this.sampleCounts.totalLineHits:this.sampleCounts.selfLineHits).get(e)??0)/this.maxSampleCounts[this.heatmapMode]),t.style.setProperty("--ig-hotness",`${s}`)})}addEventListeners(){this.viewport.addEventListener("wheel",e=>{e.preventDefault();let s=this.zoom;if(e.ctrlKey){s=Math.max(Mt,Math.min(Nt,this.zoom*Math.pow(St,-e.deltaY*Ct)));let n=s/this.zoom-1;this.zoom=s;let{x:r,y:i}=this.viewport.getBoundingClientRect(),l=e.clientX-r-this.translation.x,c=e.clientY-i-this.translation.y;this.translation.x-=l*n,this.translation.y-=c*n}else this.translation.x-=e.deltaX,this.translation.y-=e.deltaY;let o=this.clampTranslation(this.translation,s);this.translation.x=o.x,this.translation.y=o.y,this.animating=!1,this.updatePanAndZoom()}),this.viewport.addEventListener("pointerdown",e=>{e.pointerType==="mouse"&&!(e.button===0||e.button===1)||(e.preventDefault(),this.viewport.setPointerCapture(e.pointerId),this.startMousePos={x:e.clientX,y:e.clientY},this.lastMousePos={x:e.clientX,y:e.clientY},this.animating=!1)}),this.viewport.addEventListener("pointermove",e=>{if(!this.viewport.hasPointerCapture(e.pointerId))return;let s=e.clientX-this.lastMousePos.x,o=e.clientY-this.lastMousePos.y;this.translation.x+=s,this.translation.y+=o,this.lastMousePos={x:e.clientX,y:e.clientY};let n=this.clampTranslation(this.translation,this.zoom);this.translation.x=n.x,this.translation.y=n.y,this.animating=!1,this.updatePanAndZoom()}),this.viewport.addEventListener("pointerup",e=>{this.viewport.releasePointerCapture(e.pointerId);let s=2,o=this.startMousePos.x-e.clientX,n=this.startMousePos.y-e.clientY;Math.abs(o)<=s&&Math.abs(n)<=s&&this.setSelection([]),this.animating=!1}),new ResizeObserver(e=>{w(e.length===1);let s=e[0].contentRect;this.viewportSize.x=s.width,this.viewportSize.y=s.height}).observe(this.viewport)}setSelection(t,e=0){this.setSelectionRaw(t,e),e?this.nav={visited:[e],currentIndex:0,siblings:[e]}:this.nav={visited:[],currentIndex:-1,siblings:[]}}setSelectionRaw(t,e){this.selectedBlockPtrs.clear();for(let s of[...t,e])this.blocksByPtr.has(s)&&this.selectedBlockPtrs.add(s);this.lastSelectedBlockPtr=this.blocksByPtr.has(e)?e:0,this.renderSelection()}navigate(t){let e=this.lastSelectedBlockPtr;if(t==="down"||t==="up")if(e){let s=I(this.blocksByPtr.get(e)),o=(t==="down"?s.succs:s.preds).map(r=>r.ptr);s.ptr!==this.nav.visited[this.nav.currentIndex]&&(this.nav.visited=[s.ptr],this.nav.currentIndex=0);let n=this.nav.currentIndex+(t==="down"?1:-1);if(0<=n&&n<this.nav.visited.length)this.nav.currentIndex=n,this.nav.siblings=o;else{let r=o[0];r!==void 0&&(t==="down"?(this.nav.visited.push(r),this.nav.currentIndex+=1,w(this.nav.currentIndex===this.nav.visited.length-1)):(this.nav.visited.unshift(r),w(this.nav.currentIndex===0)),this.nav.siblings=o)}this.setSelectionRaw([],this.nav.visited[this.nav.currentIndex])}else{let s=[...this.blocks].sort((l,c)=>l.id-c.id),o=s.filter(l=>l.preds.length===0),n=s.filter(l=>l.succs.length===0),r=t==="down"?o:n,i=r[0];w(i),this.setSelectionRaw([],i.ptr),this.nav={visited:[i.ptr],currentIndex:0,siblings:r.map(l=>l.ptr)}}else if(e!==void 0){let s=this.nav.siblings.indexOf(e);w(s>=0,"currently selected node should be in siblings array");let o=s+(t==="right"?1:-1);0<=o&&o<this.nav.siblings.length&&this.setSelectionRaw([],this.nav.siblings[o])}w(this.nav.visited.length===0||this.nav.siblings.includes(this.nav.visited[this.nav.currentIndex]),"expected currently visited node to be in the siblings array"),w(this.lastSelectedBlockPtr===0||this.nav.siblings.includes(this.lastSelectedBlockPtr),"expected currently selected block to be in siblings array")}toggleInstructionHighlight(t,e){this.removeNonexistentHighlights();let s=this.highlightedInstructions.findIndex(n=>n.ptr===t),o=s>=0;if(e!==void 0&&(o=!e),o)s>=0&&this.highlightedInstructions.splice(s,1);else if(s<0){let n=0;for(;;){if(this.highlightedInstructions.find(r=>r.paletteColor===n)){n+=1;continue}break}this.highlightedInstructions.push({ptr:t,paletteColor:n})}this.updateHighlightedInstructions()}clampTranslation(t,e){let s=R-this.size.x*e,o=this.viewportSize.x-R,n=R-this.size.y*e,r=this.viewportSize.y-R,i=V(t.x,s,o),l=V(t.y,n,r);return{x:i,y:l}}updatePanAndZoom(){let t=this.clampTranslation(this.translation,this.zoom);this.graphContainer.style.transform=`translate(${t.x}px, ${t.y}px) scale(${this.zoom})`}graph2viewport(t,e=this.translation,s=this.zoom){return{x:t.x*s+e.x,y:t.y*s+e.y}}viewport2graph(t,e=this.translation,s=this.zoom){return{x:(t.x-e.x)/s,y:(t.y-e.y)/s}}async goToGraphCoordinates(t,{zoom:e=this.zoom,animate:s=!0}){let o={x:-t.x*e,y:-t.y*e};if(!s){this.animating=!1,this.translation.x=o.x,this.translation.y=o.y,this.zoom=e,this.updatePanAndZoom(),await new Promise(r=>setTimeout(r,0));return}if(this.targetTranslation=o,this.targetZoom=e,this.animating)return;this.animating=!0;let n=performance.now();for(;this.animating;){let r=await new Promise(m=>requestAnimationFrame(m)),i=(r-n)/1e3;n=r;let l=1,c=.01,h=1e-6,d=this.targetTranslation.x-this.translation.x,u=this.targetTranslation.y-this.translation.y,p=this.targetZoom-this.zoom;if(this.translation.x=A(this.translation.x,this.targetTranslation.x,h,i),this.translation.y=A(this.translation.y,this.targetTranslation.y,h,i),this.zoom=A(this.zoom,this.targetZoom,h,i),this.updatePanAndZoom(),Math.abs(d)<=l&&Math.abs(u)<=l&&Math.abs(p)<=c){this.translation.x=this.targetTranslation.x,this.translation.y=this.targetTranslation.y,this.zoom=this.targetZoom,this.animating=!1,this.updatePanAndZoom();break}}await new Promise(r=>setTimeout(r,0))}jumpToBlock(t,{zoom:e=this.zoom,animate:s=!0,viewportPos:o}={}){let n=this.blocksByPtr.get(t);if(!n)return Promise.resolve();if(!n.layoutNode)return this.deferredJumpToBlock={blockPtr:t,opts:{zoom:e,animate:s,viewportPos:o}},Promise.resolve();let r;return o?r={x:n.layoutNode.pos.x-o.x/e,y:n.layoutNode.pos.y-o.y/e}:r=this.graphPosToCenterRect(n.layoutNode.pos,n.layoutNode.size,e),this.goToGraphCoordinates(r,{zoom:e,animate:s})}async jumpToInstruction(t,{zoom:e=this.zoom,animate:s=!0}){let o=this.graphContainer.querySelector(`.ig-ins[data-ig-ins-id="${t}"]`);if(!o)return;let n=o.getBoundingClientRect(),r=this.graphContainer.getBoundingClientRect(),i=(n.x-r.x)/this.zoom,l=(n.y-r.y)/this.zoom,c=n.width/this.zoom,h=n.height/this.zoom,d=this.graphPosToCenterRect({x:i,y:l},{x:c,y:h},e);o.classList.add("ig-flash"),await this.goToGraphCoordinates(d,{zoom:e,animate:s}),o.classList.remove("ig-flash")}graphPosToCenterRect(t,e,s){let o=this.viewportSize.x/s,n=this.viewportSize.y/s,r=Math.max(20/s,(o-e.x)/2),i=Math.max(20/s,(n-e.y)/2),l=t.x-r,c=t.y-i;return{x:l,y:c}}exportState(){let t={translation:this.translation,zoom:this.zoom,heatmapMode:this.heatmapMode,highlightedInstructions:this.highlightedInstructions,selectedBlockPtrs:this.selectedBlockPtrs,lastSelectedBlockPtr:this.lastSelectedBlockPtr,viewportPosOfSelectedBlock:void 0};return this.lastSelectedBlockPtr&&(t.viewportPosOfSelectedBlock=this.graph2viewport(I(this.blocksByPtr.get(this.lastSelectedBlockPtr)).layoutNode.pos)),t}restoreState(t,e){this.translation.x=t.translation.x,this.translation.y=t.translation.y,this.zoom=t.zoom,this.heatmapMode=t.heatmapMode,this.highlightedInstructions=t.highlightedInstructions,this.setSelection(Array.from(t.selectedBlockPtrs),t.lastSelectedBlockPtr),this.updatePanAndZoom(),this.updateHotness(),this.updateHighlightedInstructions(),e.preserveSelectedBlockPosition&&this.jumpToBlock(this.lastSelectedBlockPtr,{zoom:this.zoom,animate:!1,viewportPos:t.viewportPosOfSelectedBlock})}};function*Z(a){for(let t of a)for(let e of t)e.block===null&&(yield e)}function Et(a,t,e,s,o,n,r=1){let i=$;r%2===1&&(a+=.5,e+=.5,o+=.5);let l="";if(l+=`M ${a} ${t} `,Math.abs(e-a)<2*i)l+=`C ${a} ${t+(s-t)/3} ${e} ${t+2*(s-t)/3} ${e} ${s} `;else{let d=Math.sign(e-a);l+=`L ${a} ${o-i} `,l+=`A ${i} ${i} 0 0 ${d>0?0:1} ${a+i*d} ${o} `,l+=`L ${e-i*d} ${o} `,l+=`A ${i} ${i} 0 0 ${d>0?1:0} ${e} ${o+i} `,l+=`L ${e} ${s} `}let c=document.createElementNS("http://www.w3.org/2000/svg","g"),h=document.createElementNS("http://www.w3.org/2000/svg","path");if(h.setAttribute("d",l),h.setAttribute("fill","none"),h.setAttribute("stroke","black"),h.setAttribute("stroke-width",`${r} `),c.appendChild(h),n){let d=X(e,s,180);c.appendChild(d)}return c}function $t(a,t,e,s,o,n,r=1){let i=$;r%2===1&&(a+=.5,e+=.5,o+=.5);let l="";if(l+=`M ${a} ${t} `,Math.abs(e-a)<2*i)l+=`C ${a} ${t+(s-t)/3} ${e} ${t+2*(s-t)/3} ${e} ${s} `;else{let d=Math.sign(e-a);l+=`L ${a} ${o+i} `,l+=`A ${i} ${i} 0 0 ${d>0?1:0} ${a+i*d} ${o} `,l+=`L ${e-i*d} ${o} `,l+=`A ${i} ${i} 0 0 ${d>0?0:1} ${e} ${o-i} `,l+=`L ${e} ${s} `}let c=document.createElementNS("http://www.w3.org/2000/svg","g"),h=document.createElementNS("http://www.w3.org/2000/svg","path");if(h.setAttribute("d",l),h.setAttribute("fill","none"),h.setAttribute("stroke","black"),h.setAttribute("stroke-width",`${r} `),c.appendChild(h),n){let d=X(e,s,0);c.appendChild(d)}return c}function Ht(a,t,e,s,o,n=1){let r=$;n%2===1&&(a+=.5,e+=.5,o+=.5);let i="";i+=`M ${a} ${t} `,i+=`L ${a} ${o-r} `,i+=`A ${r} ${r} 0 0 0 ${a+r} ${o} `,i+=`L ${e-r} ${o} `,i+=`A ${r} ${r} 0 0 0 ${e} ${o-r} `,i+=`L ${e} ${s} `;let l=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","path");return c.setAttribute("d",i),c.setAttribute("fill","none"),c.setAttribute("stroke","black"),c.setAttribute("stroke-width",`${n} `),l.appendChild(c),l}function At(a,t,e,s,o,n=1){let r=$;n%2===1&&(a+=.5,e+=.5,t+=.5,s+=.5,o+=.5);let i="";i+=`M ${a} ${t} `,i+=`L ${a} ${o+r} `,i+=`A ${r} ${r} 0 0 0 ${a-r} ${o} `,i+=`L ${e+r} ${o} `,i+=`A ${r} ${r} 0 0 0 ${e} ${o+r} `,i+=`L ${e} ${s} `;let l=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("d",i),c.setAttribute("fill","none"),c.setAttribute("stroke","black"),c.setAttribute("stroke-width",`${n} `),l.appendChild(c);let h=X(e,s,180);return l.appendChild(h),l}function X(a,t,e,s=5){let o=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("d",`M 0 0 L ${-s} ${s*1.5} L ${s} ${s*1.5} Z`),o.setAttribute("transform",`translate(${a}, ${t}) rotate(${e})`),o}function ot(a,t){a.classList.add("ig-highlight"),a.style.setProperty("--ig-highlight-color",t)}function Ot(a){a.classList.remove("ig-highlight"),a.style.setProperty("--ig-highlight-color","transparent")}var H=class{constructor(t,{func:e,pass:s=0,sampleCounts:o}){this.graph=null,this.func=e,this.passNumber=s,this.sampleCounts=o,this.keyPasses=[null,null,null,null];{let n=null;for(let[r,i]of e.passes.entries())i.mir.blocks.length>0&&(this.keyPasses[0]===null&&(this.keyPasses[0]=r),i.lir.blocks.length===0&&(this.keyPasses[1]=r)),i.lir.blocks.length>0&&(n?.lir.blocks.length===0&&(this.keyPasses[2]=r),this.keyPasses[3]=r),n=i}this.redundantPasses=[];{let n=null;for(let[r,i]of e.passes.entries()){if(n===null){n=i;continue}C(n.mir,i.mir)&&C(n.lir,i.lir)&&this.redundantPasses.push(r),n=i}}this.viewport=b("div",["ig-flex-grow-1","ig-overflow-hidden"],n=>{n.style.position="relative"}),this.sidebarLinks=e.passes.map((n,r)=>b("a",["ig-link-normal","ig-pv1","ig-ph2","ig-flex","ig-g2"],i=>{i.href="#",i.addEventListener("click",l=>{l.preventDefault(),this.switchPass(r)}),i.style.minWidth="100%"},[b("div",["ig-w1","ig-tr","ig-f6","ig-text-dim"],i=>{i.style.paddingTop="0.08rem",i.style.flexShrink="0"},[`${r}`]),b("div",[this.redundantPasses.includes(r)&&"ig-text-dim"],i=>{i.style.whiteSpace="nowrap"},[n.name])])),this.container=b("div",["ig-absolute","ig-absolute-fill","ig-flex"],()=>{},[b("div",["ig-w5","ig-br","ig-flex-shrink-0","ig-overflow-y-auto","ig-bg-white"],n=>{n.style.overflowX="auto"},[...this.sidebarLinks]),this.viewport]),t.appendChild(this.container),this.keydownHandler=this.keydownHandler.bind(this),this.tweakHandler=this.tweakHandler.bind(this),window.addEventListener("keydown",this.keydownHandler),window.addEventListener("tweak",this.tweakHandler),this.update()}destroy(){this.container.remove(),window.removeEventListener("keydown",this.keydownHandler),window.removeEventListener("tweak",this.tweakHandler)}update(){for(let[s,o]of this.sidebarLinks.entries())o.classList.toggle("ig-bg-primary",this.passNumber===s);let t=this.graph?.exportState();this.viewport.innerHTML="",this.graph=null;let e=this.func.passes[this.passNumber];if(e)try{this.graph=new F(this.viewport,e,{sampleCounts:this.sampleCounts}),t&&this.graph.restoreState(t,{preserveSelectedBlockPosition:!0})}catch(s){this.viewport.innerHTML="An error occurred while laying out the graph. See console.",console.error(s)}}switchPass(t){this.passNumber=t,this.update()}keydownHandler(t){switch(t.key){case"w":case"s":this.graph?.navigate(t.key==="s"?"down":"up"),this.graph?.jumpToBlock(this.graph.lastSelectedBlockPtr);break;case"a":case"d":this.graph?.navigate(t.key==="d"?"right":"left"),this.graph?.jumpToBlock(this.graph.lastSelectedBlockPtr);break;case"f":for(let e=this.passNumber+1;e<this.func.passes.length;e++)if(!this.redundantPasses.includes(e)){this.switchPass(e);break}break;case"r":for(let e=this.passNumber-1;e>=0;e--)if(!this.redundantPasses.includes(e)){this.switchPass(e);break}break;case"1":case"2":case"3":case"4":{let e=["1","2","3","4"].indexOf(t.key),s=this.keyPasses[e];typeof s=="number"&&this.switchPass(s)}break;case"c":{let e=this.graph?.blocksByPtr.get(this.graph?.lastSelectedBlockPtr??-1);e&&this.graph?.jumpToBlock(e.ptr,{zoom:1})}break}}tweakHandler(){this.update()}};var S=new URL(window.location.toString()).searchParams,Rt=S.has("func")?parseInt(S.get("func"),10):void 0,rt=S.has("pass")?parseInt(S.get("pass"),10):void 0,z=class{constructor(t){this.exportButton=null,this.ionjson=null,this.funcIndex=Rt??0,this.funcSelected=t.funcSelected,this.funcSelector=b("div",[],()=>{},["Function",b("input",["ig-w3"],e=>{e.type="number",e.min="1",e.addEventListener("input",()=>{this.switchFunc(parseInt(e.value,10)-1)})},[])," / ",b("span",["num-functions"])]),this.funcSelectorNone=b("div",[],()=>{},["No functions to display."]),this.funcName=b("div"),this.root=b("div",["ig-bb","ig-flex","ig-bg-white"],()=>{},[b("div",["ig-pv2","ig-ph3","ig-flex","ig-g2","ig-items-center","ig-br","ig-hide-if-empty"],()=>{},[t.browse&&b("div",[],()=>{},[b("input",[],e=>{e.type="file",e.addEventListener("change",s=>{let o=s.target;o.files?.length&&this.fileSelected(o.files[0])})})]),this.funcSelector,this.funcSelectorNone]),b("div",["ig-flex-grow-1","ig-pv2","ig-ph3","ig-flex","ig-g2","ig-items-center"],()=>{},[this.funcName,b("div",["ig-flex-grow-1"]),t.export&&b("div",[],()=>{},[b("button",[],e=>{this.exportButton=e,e.addEventListener("click",()=>{this.exportStandalone()})},["Export"])])])]),this.update()}async fileSelected(t){let e=JSON.parse(await t.text());this.ionjson=j(e),this.switchFunc(0),this.update()}switchIonJSON(t){this.ionjson=t,this.switchFunc(this.funcIndex)}switchFunc(t){t=Math.max(0,Math.min(this.numFunctions()-1,t)),this.funcIndex=isNaN(t)?0:t,this.funcSelected(this.ionjson?.functions[this.funcIndex]??null),this.update()}numFunctions(){return this.ionjson?.functions.length??0}update(){let t=0<=this.funcIndex&&this.funcIndex<this.numFunctions();this.funcSelector.hidden=this.numFunctions()<=1,this.funcSelectorNone.hidden=!(this.ionjson&&this.numFunctions()===0);let e=this.funcSelector.querySelector("input");e.max=`${this.numFunctions()}`,e.value=`${this.funcIndex+1}`,this.funcSelector.querySelector(".num-functions").innerHTML=`${this.numFunctions()}`,this.funcName.hidden=!t,this.funcName.innerText=`${this.ionjson?.functions[this.funcIndex].name??""}`,this.exportButton&&(this.exportButton.disabled=!this.ionjson||!t)}async exportStandalone(){let t=I(this.ionjson),e=t.functions[this.funcIndex].name,s={version:1,functions:[t.functions[this.funcIndex]]},n=(window.__standaloneTemplate??await(await fetch("./standalone.html")).text()).replace(/\{\{\s*IONJSON\s*\}\}/,JSON.stringify(s)),r=URL.createObjectURL(new Blob([n],{type:"text/html;charset=utf-8"})),i=document.createElement("a");i.href=r,i.download=`iongraph-${e}.html`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(r)}},U=class{constructor(){this.menuBar=new z({browse:!0,export:!0,funcSelected:t=>this.switchFunc(t)}),this.func=null,this.sampleCountsFromFile=void 0,this.graph=null,this.loadStuffFromQueryParams(),this.graphContainer=b("div",["ig-relative","ig-flex-basis-0","ig-flex-grow-1","ig-overflow-hidden"]),this.root=b("div",["ig-absolute","ig-absolute-fill","ig-flex","ig-flex-column"],t=>{t.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation()}),t.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation()}),t.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation();let s=e.dataTransfer?.files;s&&s.length>0&&this.menuBar.fileSelected(s[0])})},[this.menuBar.root,this.graphContainer]),this.update()}update(){this.graph&&this.graph.destroy(),this.func&&(this.graph=new H(this.graphContainer,{func:this.func,pass:rt,sampleCounts:this.sampleCountsFromFile}))}loadStuffFromQueryParams(){(async()=>{let t=S.get("file");if(t){let s=await(await fetch(t)).json(),o=j(s);this.menuBar.switchIonJSON(o)}})(),(async()=>{let t=S.get("sampleCounts");if(t){let s=await(await fetch(t)).json();this.sampleCountsFromFile={selfLineHits:new Map(s.selfLineHits),totalLineHits:new Map(s.totalLineHits)},this.update()}})()}switchFunc(t){this.func=t,this.update()}},q=class{constructor(){this.menuBar=new z({funcSelected:t=>this.switchFunc(t)}),this.func=null,this.graph=null,this.graphContainer=b("div",["ig-relative","ig-flex-basis-0","ig-flex-grow-1","ig-overflow-hidden"]),this.root=b("div",["ig-absolute","ig-absolute-fill","ig-flex","ig-flex-column"],()=>{},[this.menuBar.root,this.graphContainer])}update(){this.graph&&this.graph.destroy(),this.func&&(this.graph=new H(this.graphContainer,{func:this.func,pass:rt}))}setIonJSON(t){this.menuBar.switchIonJSON(t)}switchFunc(t){this.func=t,this.update()}};return mt(Dt);})();
</script>
  <script>window.__exportedIonJSON = {{ IONJSON }}</script>
  <script>
    const ui = new iongraph.StandaloneUI();
    document.body.appendChild(ui.root);
    ui.setIonJSON(window.__exportedIonJSON);
  </script>
</body>
